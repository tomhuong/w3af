#
#???????w3af?????
#??http://w3af.org/how-w3af-uses-continuous-integration-to-improve
#
#????,?????????
#
?:
  ??:
    - ????

  ??:
    ??:2.7.3

  ??:
    #??????python???????
    #?/usr/lib/python2.7/dist-packages/????gtk?????
    #?????virtualenv???python
    -  pyenv????


??:
  ??:
    #??auto_update????git???????,????
    #this??????(??CircleCI???perf)?
    #??????????,??????
    - ??[[-e .git / shallow]]; ??git fetch --unshallow; ??


????:
  cache_directories:
    #???w3af???
    - “xpresser”

  ?:
    - ??????
    - ???
    - ????

    -  sudo apt-get update

    #GUI???
    # -  sudo apt-get install -y python-gtksourceview2 python-gtk2 gir1.2-notify-0.7 python-pyatspi2
    #python-dbus python-pygame python-opencv python-scipy python-numpy
    -  sudo apt-get install -y python-webkit

    #Misc???
    -  sudo apt-get install -y stunnel4 libffi-dev tcpdump joe

    #glam.clamav???ClamAV??
    -  sudo apt-get install clamav-daemon clamav-freshclam clamav-unofficial-sigs
    -  sudo service clamav-daemon start

    #????/??????
    -  pip install --upgrade pip
    -  w3af / core / controllers / ci / install_scripts / install_core_dependencies.sh

    #??GUI???
    -  w3af / core / controllers / ci / install_scripts / install_gui_dependencies.sh

    #?GUI?????venv
    -  w3af / core / controllers / ci / install_scripts / install_c_extensions_venv.sh

    #???????
    -  w3af / core / controllers / ci / install_scripts / install_test_dependencies.sh

    #???????/???
    -  cd w3af / tests / && docker-compose up -d
    -  w3af / tests / add-test-routes.sh

    #?????????,???????????
    #
    #??????????????????????
    #??,??https://circleci.com/gh/andresriancho/w3af/2819#tests/containers/0
    #
    #????????,????VM?????????
    #collection artifact?memory-usage.txt????????????
    #copleci??????????ID????ID
    #???????,??????????
    #???????
    -  python w3af / core / controllers / ci / nosetests_wrapper / show-test-ids.py

    #????????docker-compose up??????
    -  w3af / tests / waitfor-test-dependencies.py

  ??:
    -  pip --version
    -  pip??


??:
  ??:
    -  w3af / core / controllers / ci / nosetests_wrapper / main.py:
        ??:360

    -  nosetests w3af / core / data / constants / tests / test_vulns.py:TestVulnsConstants.test_vuln_updated

    #???????????
    - ??`docker ps -q`??c; do docker logs $ c> $ CIRCLE_ARTIFACTS / docker- $ c.log; DONE

#https://bitbucket.org/ned/coveragepy/issue/282/coverage-combine-consumes-a-lot-of-memory         
#post:
# - ?????
# - ???

??:
  ??:
    ??:??
    ??:andresriancho
    ??:
      #?docker hub???????
      -  sed“s / <EMAIL> / $ DOCKER_EMAIL /; s / <AUTH> / $ DOCKER_AUTH /”<extras / docker / dockercfg.template>?/ .dockercfg

      #??URL??master
      - “curl --header'????:application / json' -  request POST https://circleci.com/api/v1/project/andresriancho/w3af-module/tree/master?circle-token=$W3AF_MODULE_TOKEN”
      - “curl --header'Content-Type:application / json'-request POST https://circleci.com/api/v1/project/andresriancho/w3af-kali-ci/tree/master?circle-token=$ W3AF_KALI_TOKEN”
      - “curl --header'Content-Type:application / json'-request POST https://circleci.com/api/v1/project/andresriancho/w3af-api-client/tree/master?circle-token=$ W3AF_API_CLIENT_TOKEN”

      #bocker??????????hack:?????????????
      repo?#,?????????????
      #????????????,??????????????
      #????????git-tracked??????
      #?????????????
      #
      #?????1??????,??????????????
      #??????,???master / develop?
      #????
      - ? ?-exec touch -t 201401010000 {} \;
      - ??x??x(git ls-tree --full-tree --name-only -r HEAD); ??-t $(date -d“$(git log -1 --format =%ci”$ {x}“)”+%y%m%d%H%M?%S)“$ {x} “; DONE

      -  docker pull andresriancho / w3af:latest; ??
      -  ./docker-build.sh master:
          pwd:extras / docker /

      -  docker push andresriancho / w3af:??
      -  w3af / core / controllers / ci / circleci / trigger-w3af-api-build.py

  ??:
    ??:??
    ??:andresriancho
    ??:
      #?docker hub???????
      -  sed“s / <EMAIL> / $ DOCKER_EMAIL /; s / <AUTH> / $ DOCKER_AUTH /”<extras / docker / dockercfg.template>?/ .dockercfg

      #??URL????
      - “curl --header'????:application / json' -  request POST https://circleci.com/api/v1/project/andresriancho/w3af-module/tree/develop?circle-token=$W3AF_MODULE_TOKEN”
      - “curl --header'Content-Type:application / json'-request POST https://circleci.com/api/v1/project/andresriancho/w3af-api-client/tree/develop?circle-token=$ W3AF_API_CLIENT_TOKEN”

      #bocker??????????hack:?????????????
      repo?#,?????????????
      #????????????,??????????????
      #????????git-tracked??????
      #?????????????
      #
      #?????1??????,??????????????
      #??????,???master / develop?
      #????
      - ? ?-exec touch -t 201401010000 {} \;
      - ??x??x(git ls-tree --full-tree --name-only -r HEAD); ??-t $(date -d“$(git log -1 --format =%ci”$ {x}“)”+%y%m%d%H%M?%S)“$ {x} “; DONE

      -  docker pull andresriancho / w3af:develop; ??
      -  ./docker-build.sh develop:
          pwd:extras / docker /

      -  w3af / core / controllers / ci / circleci / trigger-w3af-api-build.py